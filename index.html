<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Supabase -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
    window.supabase = createClient('https://your-project.supabase.co', 'your-anon-key');
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; color: #2c3e50; }
    .admin-body { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 80px; background: #1a1a2e; position: fixed; top: 0; bottom: 0; left: 0;
      z-index: 100; transition: width 0.3s ease; overflow: hidden;
    }
    .sidebar:hover { width: 240px; }
    .sidebar-inner { padding: 20px 0; height: 100%; display: flex; flex-direction: column; }
    .logo { display: flex; justify-content: center; align-items: center; height: 60px; margin-bottom: 30px; }
    .logo svg { width: 32px; height: 32px; fill: #fff; }

    .nav { flex: 1; }
    .nav-link {
      display: flex; align-items: center; padding: 14px 20px; color: #b0b3b8;
      text-decoration: none; transition: all 0.3s ease; position: relative;
    }
    .nav-link svg { width: 24px; height: 24px; fill: #b0b3b8; flex-shrink: 0; }
    .nav-link span { margin-left: 20px; white-space: nowrap; opacity: 0; transform: translateX(-10px); transition: all 0.3s; }
    .sidebar:hover .nav-link span { opacity: 1; transform: translateX(0); }
    .nav-link:hover, .nav-link.active { background: #16213e; color: #fff; }
    .nav-link:hover svg, .nav-link.active svg { fill: #fff; }

    /* Main */
    .main-content { margin-left: 80px; flex: 1; padding: 30px; transition: margin-left 0.3s; }
    .sidebar:hover ~ .main-content { margin-left: 240px; }

    .container { max-width: 1200px; margin: auto; }
    h1 { text-align: center; margin-bottom: 30px; }

    /* Tabs */
    .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }
    .tab-btn { padding: 10px 20px; background: #ddd; border: none; border-radius: 6px; cursor: pointer; }
    .tab-btn.active { background: #2c3e50; color: white; }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
    .progress-ring { position: relative; width: 100px; height: 100px; margin: 0 auto; }
    .progress-ring circle { fill: none; stroke-width: 10; transform: rotate(-90deg); transform-origin: 50% 50%; }
    .progress-ring .bg { stroke: #e0e0e0; }
    .progress-ring .fg { stroke: #27ae60; stroke-linecap: round; transition: stroke-dashoffset 0.5s; }
    .progress-ring .label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; font-weight: bold; }

    /* Products Table */
    .products-table {
      background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; }
    .actions button { margin: 0 5px; padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
    .edit-btn { background: #3498db; color: white; }
    .delete-btn { background: #e74c3c; color: white; }

    /* Modals */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 30px; border-radius: 12px; width: 500px; max-height: 90vh; overflow-y: auto;
    }
    .modal input, .modal textarea, .modal select, .modal button {
      width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px;
    }
    .modal button { background: #27ae60; color: white; border: none; cursor: pointer; font-weight: 600; }
    .modal button:hover { background: #219653; }
    .price-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    #message { margin-top: 15px; font-weight: bold; text-align: center; }

    @media (max-width: 768px) {
      .sidebar { width: 60px; }
      .sidebar:hover { width: 200px; }
      .main-content { margin-left: 60px; padding: 15px; }
      .sidebar:hover ~ .main-content { margin-left: 200px; }
      .tab-buttons { flex-direction: column; }
    }
  </style>
</head>
<body class="admin-body">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-inner">
      <a href="#" class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
      </a>
      <nav class="nav">
        <a href="#" class="nav-link active" data-tab="dashboard">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
          <span>Dashboard</span>
        </a>
        <a href="admin.html" class="nav-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a1 1 0 0 1 1 1v8h8a1 1 0 1 1 0 2h-8v8a1 1 0 1 1-2 0v-8H3a1 1 0 1 1 0-2h8V3a1 1 0 0 1 1-1z"/></svg>
          <span>Add Product</span>
        </a>
        <a href="#" class="nav-link" id="invite-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 00-3-3.87"></path><path d="M16 3.13a4 4 0 010 7.75"></path></svg>
          <span>Invite User</span>
        </a>
        <a href="#" class="nav-link" id="logout">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          <span>Logout</span>
        </a>
      </nav>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <h1>Admin Dashboard</h1>
      <div id="auth-status">Checking...</div>

      <!-- Tab Buttons -->
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
        <button class="tab-btn" data-tab="products">Manage Products</button>
      </div>

      <!-- Dashboard Tab -->
      <div id="dashboard-tab">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="progress-ring">
              <svg><circle class="bg" cx="50" cy="50" r="40"></circle><circle class="fg" cx="50" cy="50" r="40" id="stock-circle"></circle></svg>
              <div class="label" id="stock-label">0%</div>
            </div>
            <h3 id="stock-left">0</h3>
            <p>Stock Left</p>
          </div>
          <div class="stat-card">
            <div class="progress-ring">
              <svg><circle class="bg" cx="50" cy="50" r="40"></circle><circle class="fg" cx="50" cy="50" r="40" id="sales-circle" style="stroke:#3498db;"></circle></svg>
              <div class="label" id="sales-label">0</div>
            </div>
            <h3 id="total-sales">0</h3>
            <p>Total Sales</p>
          </div>
          <div class="stat-card">
            <h3 id="revenue-zar">R 0.00</h3>
            <p>Revenue (ZAR)</p>
          </div>
          <div class="stat-card">
            <h3 id="invested">R 0.00</h3>
            <p>Invested</p>
          </div>
        </div>
        <div class="charts-grid">
          <div class="chart-box"><canvas id="salesChart"></canvas></div>
          <div class="chart-box"><canvas id="revenueChart"></canvas></div>
        </div>
      </div>

      <!-- Products Tab -->
      <div id="products-tab" style="display:none;">
        <div class="products-table">
          <table id="products-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Price (ZAR)</th>
                <th>Sizes</th>
                <th>Stock</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Edit Product Modal -->
  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <h2>Edit Product</h2>
      <input type="hidden" id="edit-id" />
      <input type="text" id="edit-name" placeholder="Name" />
      <textarea id="edit-description" placeholder="Description"></textarea>
      <div class="price-group">
        <input type="number" id="edit-price_zar" step="0.01" placeholder="Price (ZAR)" />
        <input type="number" id="edit-price_mwk" step="0.01" placeholder="Price (MWK)" />
      </div>
      <input type="text" id="edit-sizes" placeholder="Sizes (S,M,L)" />
      <input type="text" id="edit-colors" placeholder="Colors (Red,Blue)" />
      <input type="text" id="edit-category" placeholder="Category" />
      <label><input type="checkbox" id="edit-in_stock" /> In Stock</label>
      <button id="save-edit">Save Changes</button>
      <div id="edit-message"></div>
    </div>
  </div>

  <!-- Invite Modal -->
  <div class="modal" id="invite-modal">
    <div class="modal-content">
      <h2>Invite User</h2>
      <input type="email" id="invite-email" placeholder="Email" />
      <select id="invite-role"><option value="user">User</option><option value="admin">Admin</option></select>
      <button id="send-invite">Send Invite</button>
      <div id="message"></div>
    </div>
  </div>

  <!-- JavaScript -->
  <script type="module">
    const authStatus = document.getElementById('auth-status');
    const stockEl = document.getElementById('stock-left');
    const salesEl = document.getElementById('total-sales');
    const revenueEl = document.getElementById('revenue-zar');
    const investedEl = document.getElementById('invested');
    const stockCircle = document.getElementById('stock-circle');
    const salesCircle = document.getElementById('sales-circle');
    const stockLabel = document.getElementById('stock-label');
    const salesLabel = document.getElementById('sales-label');
    const productsTbody = document.querySelector('#products-table tbody');
    const editModal = document.getElementById('edit-modal');
    const inviteModal = document.getElementById('invite-modal');
    const messageEl = document.getElementById('message');
    const editMessage = document.getElementById('edit-message');

    let salesChart, revenueChart;

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('dashboard-tab').style.display = btn.dataset.tab === 'dashboard' ? 'block' : 'none';
        document.getElementById('products-tab').style.display = btn.dataset.tab === 'products' ? 'block' : 'none';
        if (btn.dataset.tab === 'products') loadProducts();
      };
    });

    // Check Admin
    async function init() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return authStatus.innerHTML = `<a href="index.html">Login</a>`;

      const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
      if (profile?.role !== 'admin') return authStatus.textContent = 'Access denied.';

      authStatus.innerHTML = `Admin: ${user.email} | <a href="#" id="logout">Logout</a>`;
      document.getElementById('logout').onclick = () => supabase.auth.signOut().then(() => location.href = 'index.html');

      loadDashboard();
      setupRealtime();
      setupInvite();
    }

    // Load Dashboard
    async function loadDashboard() {
      const { count: inStock } = await supabase.from('products').select('*', { count: 'exact', head: true }).eq('in_stock', true);
      const { count: totalStock } = await supabase.from('products').select('*', { count: 'exact', head: true });
      const stockPct = totalStock ? Math.round((inStock / totalStock) * 100) : 0;
      stockEl.textContent = inStock;
      stockLabel.textContent = `${stockPct}%`;
      stockCircle.style.strokeDasharray = '251.2, 251.2';
      stockCircle.style.strokeDashoffset = 251.2 - (251.2 * stockPct / 100);

      const { count: salesCount } = await supabase.from('orders').select('*', { count: 'exact', head: true });
      salesEl.textContent = salesCount;
      salesLabel.textContent = salesCount;

      const { data: orders } = await supabase.from('orders').select('total_zar, created_at');
      const revenue = orders.reduce((s, o) => s + (o.total_zar || 0), 0);
      revenueEl.textContent = `R ${revenue.toFixed(2)}`;

      const { data: settings } = await supabase.from('settings').select('invested_amount').single();
      investedEl.textContent = `R ${(settings?.invested_amount || 0).toFixed(2)}`;

      updateCharts(orders);
    }

    function updateCharts(orders) {
      const monthlySales = Array(12).fill(0);
      const monthlyRevenue = Array(12).fill(0);
      const now = new Date();
      orders.forEach(o => {
        const d = new Date(o.created_at);
        if (d.getFullYear() === now.getFullYear()) {
          const m = d.getMonth();
          monthlySales[m]++;
          monthlyRevenue[m] += o.total_zar || 0;
        }
      });

      if (salesChart) salesChart.destroy();
      if (revenueChart) revenueChart.destroy();

      salesChart = new Chart(document.getElementById('salesChart'), {
        type: 'line', data: { labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], datasets: [{ label: 'Sales', data: monthlySales, borderColor: '#3498db', tension: 0.4 }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });

      revenueChart = new Chart(document.getElementById('revenueChart'), {
        type: 'bar', data: { labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], datasets: [{ label: 'Revenue', data: monthlyRevenue, backgroundColor: '#27ae60' }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }

    // Load Products
    async function loadProducts() {
      const { data: products } = await supabase.from('products').select('*');
      productsTbody.innerHTML = products.map(p => `
        <tr>
          <td>${p.name}</td>
          <td>R ${p.price_zar}</td>
          <td>${p.sizes.join(', ')}</td>
          <td>${p.in_stock ? 'Yes' : 'No'}</td>
          <td class="actions">
            <button class="edit-btn" onclick="openEdit(${p.id})">Edit</button>
            <button class="delete-btn" onclick="deleteProduct(${p.id})">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // Edit Product
    window.openEdit = async (id) => {
      const { data: product } = await supabase.from('products').select('*').eq('id', id).single();
      document.getElementById('edit-id').value = product.id;
      document.getElementById('edit-name').value = product.name;
      document.getElementById('edit-description').value = product.description;
      document.getElementById('edit-price_zar').value = product.price_zar;
      document.getElementById('edit-price_mwk').value = product.price_mwk;
      document.getElementById('edit-sizes').value = product.sizes.join(', ');
      document.getElementById('edit-colors').value = product.colors.join(', ');
      document.getElementById('edit-category').value = product.category;
      document.getElementById('edit-in_stock').checked = product.in_stock;
      editModal.style.display = 'flex';
    };

    document.getElementById('save-edit').onclick = async () => {
      const id = document.getElementById('edit-id').value;
      const updates = {
        name: document.getElementById('edit-name').value,
        description: document.getElementById('edit-description').value,
        price_zar: parseFloat(document.getElementById('edit-price_zar').value),
        price_mwk: parseFloat(document.getElementById('edit-price_mwk').value),
        sizes: document.getElementById('edit-sizes').value.split(',').map(s => s.trim()),
        colors: document.getElementById('edit-colors').value.split(',').map(c => c.trim()),
        category: document.getElementById('edit-category').value,
        in_stock: document.getElementById('edit-in_stock').checked
      };

      const { error } = await supabase.from('products').update(updates).eq('id', id);
      editMessage.innerHTML = error
        ? `<span style="color:red">${error.message}</span>`
        : `<span style="color:green">Updated!</span>`;
      if (!error) setTimeout(() => { editModal.style.display = 'none'; loadProducts(); }, 1000);
    };

    // Delete Product
    window.deleteProduct = async (id) => {
      if (confirm('Delete this product?')) {
        await supabase.from('products').delete().eq('id', id);
        loadProducts();
      }
    };

    // Realtime
    function setupRealtime() {
      supabase.channel('admin')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, () => { loadDashboard(); if (document.querySelector('[data-tab="products"]').classList.contains('active')) loadProducts(); })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, loadDashboard)
        .subscribe();
    }

    // Invite
    function setupInvite() {
      document.getElementById('invite-link').onclick = (e) => { e.preventDefault(); inviteModal.style.display = 'flex'; };
      document.getElementById('send-invite').onclick = async () => {
        const email = document.getElementById('invite-email').value.trim();
        if (!email) return messageEl.innerHTML = '<span style="color:red">Enter email</span>';

        const { error } = await supabase.auth.admin.inviteUserByEmail(email, { redirect_to: `${window.location.origin}/admin.html` });
        messageEl.innerHTML = error ? `<span style="color:red">${error.message}</span>` : `<span style="color:green">Sent!</span>`;
      };
      [editModal, inviteModal].forEach(m => m.onclick = (e) => { if (e.target === m) m.style.display = 'none'; });
    }

    init();
  </script>
</body>
</html>
