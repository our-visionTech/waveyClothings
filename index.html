<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>

  <!-- Supabase Client -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
    window.supabase = createClient('https://your-project.supabase.co', 'your-anon-key');
  </script>

  <!-- Embedded CSS -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; color: #333; }
    .admin-body { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 80px; background: #1a1a2e; position: fixed; top: 0; bottom: 0; left: 0;
      z-index: 100; transition: width 0.3s ease; overflow: hidden;
    }
    .sidebar:hover { width: 240px; }
    .sidebar-inner { padding: 20px 0; height: 100%; display: flex; flex-direction: column; }
    .logo { display: flex; justify-content: center; align-items: center; height: 60px; margin-bottom: 30px; }
    .logo svg { width: 32px; height: 32px; fill: #fff; }

    .nav { flex: 1; }
    .nav-link {
      display: flex; align-items: center; padding: 14px 20px; color: #b0b3b8;
      text-decoration: none; transition: all 0.3s ease; position: relative;
    }
    .nav-link svg { width: 24px; height: 24px; fill: #b0b3b8; flex-shrink: 0; }
    .nav-link span { margin-left: 20px; white-space: nowrap; opacity: 0; transform: translateX(-10px); transition: all 0.3s; }
    .sidebar:hover .nav-link span { opacity: 1; transform: translateX(0); }
    .nav-link:hover, .nav-link.active { background: #16213e; color: #fff; }
    .nav-link:hover svg, .nav-link.active svg { fill: #fff; }

    /* Main */
    .main-content { margin-left: 80px; flex: 1; padding: 30px; transition: margin-left 0.3s; }
    .sidebar:hover ~ .main-content { margin-left: 240px; }

    .container { max-width: 1200px; margin: auto; }
    h1 { text-align: center; margin-bottom: 30px; color: #2c3e50; }

    /* Stats Cards */
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;
    }
    .stat-card {
      background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      text-align: center; transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card h3 { font-size: 2.2rem; margin: 10px 0; color: #2c3e50; }
    .stat-card p { color: #7f8c8d; font-weight: 500; }

    /* Invite Section */
    .invite-box {
      background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      max-width: 600px; margin: 0 auto;
    }
    .invite-box input {
      width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px;
    }
    .invite-box button {
      background: #27ae60; color: white; padding: 12px 20px; border: none; border-radius: 6px;
      cursor: pointer; font-weight: 600; width: 100%;
    }
    .invite-box button:hover { background: #219653; }

    #message { margin-top: 15px; text-align: center; font-weight: bold; }

    @media (max-width: 768px) {
      .sidebar { width: 60px; }
      .sidebar:hover { width: 200px; }
      .main-content { margin-left: 60px; padding: 15px; }
      .sidebar:hover ~ .main-content { margin-left: 200px; }
    }
  </style>
</head>
<body class="admin-body">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-inner">
      <a href="#" class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
      </a>
      <nav class="nav">
        <a href="#" class="nav-link active" data-page="dashboard">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
          <span>Dashboard</span>
        </a>
        <a href="admin.html" class="nav-link" data-page="products">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
          <span>Add Product</span>
        </a>
        <a href="#" class="nav-link" id="logout">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          <span>Logout</span>
        </a>
      </nav>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <h1>Admin Dashboard</h1>
      <div id="auth-status">Checking authentication...</div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="stock-left">0</h3>
          <p>Items in Stock</p>
        </div>
        <div class="stat-card">
          <h3 id="total-sales">0</h3>
          <p>Total Sales</p>
        </div>
        <div class="stat-card">
          <h3 id="revenue-zar">R 0.00</h3>
          <p>Revenue (ZAR)</p>
        </div>
        <div class="stat-card">
          <h3 id="invested">R 0.00</h3>
          <p>Invested Amount</p>
        </div>
      </div>

      <!-- Invite User -->
      <div class="invite-box">
        <h2 style="text-align:center; margin-bottom:20px;">Invite New User</h2>
        <input type="email" id="invite-email" placeholder="Enter email address" />
        <select id="invite-role">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
        <button id="send-invite">Send Invite</button>
        <div id="message"></div>
      </div>
    </div>
  </main>

  <!-- JavaScript -->
  <script type="module">
    import { supabase } from './js/supabase.js'; // We'll create this next

    const authStatus = document.getElementById('auth-status');
    const stockEl = document.getElementById('stock-left');
    const salesEl = document.getElementById('total-sales');
    const revenueEl = document.getElementById('revenue-zar');
    const investedEl = document.getElementById('invested');
    const messageEl = document.getElementById('message');

    // Check Admin
    async function init() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        authStatus.innerHTML = `<a href="index.html">Login required</a>`;
        return;
      }

      const { data: profile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single();

      if (profile?.role !== 'admin') {
        authStatus.textContent = 'Access denied.';
        return;
      }

      authStatus.innerHTML = `Admin: ${user.email} | <a href="#" id="logout">Logout</a>`;
      document.getElementById('logout').onclick = () => supabase.auth.signOut().then(() => location.href = 'index.html');

      loadDashboard();
      setupRealtime();
    }

    // Load Stats
    async function loadDashboard() {
      // Stock Left
      const { count } = await supabase.from('products').select('*', { count: 'exact', head: true }).eq('in_stock', true);
      stockEl.textContent = count;

      // Total Sales
      const { count: salesCount } = await supabase.from('orders').select('*', { count: 'exact', head: true });
      salesEl.textContent = salesCount;

      // Revenue (ZAR)
      const { data: orders } = await supabase.from('orders').select('total_zar').neq('total_zar', null);
      const revenue = orders.reduce((sum, o) => sum + (o.total_zar || 0), 0);
      revenueEl.textContent = `R ${revenue.toFixed(2)}`;

      // Invested (manual entry in settings table)
      const { data: settings } = await supabase.from('settings').select('invested_amount').single();
      investedEl.textContent = `R ${(settings?.invested_amount || 0).toFixed(2)}`;
    }

    // Real-time Updates
    function setupRealtime() {
      supabase.channel('public:products')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, () => loadDashboard())
        .subscribe();

      supabase.channel('public:orders')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => loadDashboard())
        .subscribe();
    }

    // Invite User
    document.getElementById('send-invite').onclick = async () => {
      const email = document.getElementById('invite-email').value.trim();
      const role = document.getElementById('invite-role').value;

      if (!email) return messageEl.innerHTML = '<span style="color:red">Enter email</span>';

      const { data, error } = await supabase.auth.admin.inviteUserByEmail(email, {
        redirect_to: `${window.location.origin}/admin.html`
      });

      if (error) {
        messageEl.innerHTML = `<span style="color:red">${error.message}</span>`;
      } else {
        // Auto-set role after they sign up (via trigger or manual)
        messageEl.innerHTML = `<span style="color:green">Invite sent to ${email}</span>`;
        document.getElementById('invite-email').value = '';
      }
    };

    // Auto-init
    init();
  </script>
</body>
</html>
